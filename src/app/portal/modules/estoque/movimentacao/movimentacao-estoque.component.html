<div class="movimentacao-estoque">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-arrows-alt"></i>
        Movimentação de Estoque
      </h1>
      <div class="header-actions">
        <p-button 
          icon="pi pi-plus" 
          label="Nova Movimentação" 
          severity="primary"
          (onClick)="showDialog()">
        </p-button>
        <p-button 
          icon="pi pi-download" 
          label="Exportar" 
          severity="secondary"
          (onClick)="exportarParaExcel()">
        </p-button>
      </div>
    </div>
  </div>

  <div class="filtros-section">
    <div class="filtros-header">
      <h3>{{ getFiltrosHeader() }}</h3>
      <div class="filtros-actions">
        <p-button 
          icon="pi pi-search" 
          label="Filtrar" 
          severity="primary"
          size="small"
          (onClick)="filtrar()">
        </p-button>
        <p-button 
          icon="pi pi-times" 
          label="Limpar" 
          severity="secondary"
          size="small"
          (onClick)="limparFiltros()">
        </p-button>
      </div>
    </div>

    <div class="filtros-content">
      <div class="filtros-grid">
        <div class="filtro-item">
          <label for="produto">Produto</label>
          <p-dropdown 
            id="produto"
            [options]="produtos" 
            [(ngModel)]="filtros.produtoId"
            placeholder="Selecione um produto"
            optionLabel="label"
            optionValue="value">
          </p-dropdown>
        </div>

        <div class="filtro-item">
          <label for="tipo">Tipo de Movimentação</label>
          <p-dropdown 
            id="tipo"
            [options]="tipoMovimentacaoOptions" 
            [(ngModel)]="filtros.tipoMovimentacao"
            placeholder="Selecione o tipo"
            optionLabel="label"
            optionValue="value">
          </p-dropdown>
        </div>

        <div class="filtro-item">
          <label for="data-inicio">Data Início</label>
          <p-calendar 
            id="data-inicio"
            [(ngModel)]="filtros.dataInicio"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data">
          </p-calendar>
        </div>

        <div class="filtro-item">
          <label for="data-fim">Data Fim</label>
          <p-calendar 
            id="data-fim"
            [(ngModel)]="filtros.dataFim"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data">
          </p-calendar>
        </div>

        <div class="filtro-item">
          <label for="fornecedor">Fornecedor</label>
          <input 
            id="fornecedor"
            type="text" 
            pInputText 
            [(ngModel)]="filtros.fornecedor"
            placeholder="Digite o fornecedor">
        </div>

        <div class="filtro-item">
          <label for="cliente">Cliente</label>
          <input 
            id="cliente"
            type="text" 
            pInputText 
            [(ngModel)]="filtros.cliente"
            placeholder="Digite o cliente">
        </div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <p-table 
      [value]="movimentacoes" 
      [lazy]="true"
      [lazyLoadOnInit]="false"
      [paginator]="true"
      [rows]="currentRowsPerPage"
      [rowsPerPageOptions]="rowsPerPage"
      [totalRecords]="totalRecords"
      [loading]="tblLazyLoading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} movimentações"
      [tableStyle]="{'min-width': '50rem'}"
      (onLazyLoad)="loadTableData($event)"
      (onPage)="handlePageChange($event)"
      styleClass="p-datatable-gridlines">

      <ng-template pTemplate="header">
        <tr>
          <th>Produto</th>
          <th>Tipo</th>
          <th>Quantidade</th>
          <th>Motivo</th>
          <th>Data</th>
          <th>Responsável</th>
          <th>Ações</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-movimentacao>
        <tr>
          <td>{{ movimentacao.produto?.nome }}</td>
          <td>
            <p-tag 
              [value]="movimentacao.tipoMovimentacao" 
              [severity]="movimentacao.tipoMovimentacao === 'Entrada' ? 'success' : 'danger'">
            </p-tag>
          </td>
          <td>{{ formatarQuantidade(movimentacao.quantidade, movimentacao.produto?.unidadeMedida) }}</td>
          <td>{{ movimentacao.motivo }}</td>
          <td>{{ movimentacao.dataMovimentacao }}</td>
          <td>{{ movimentacao.nomeRespMovimentacao }}</td>
          <td>
            <div class="acoes-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="info"
                size="small"
                pTooltip="Editar"
                (onClick)="iniciarEdicao(movimentacao)">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                pTooltip="Excluir"
                (onClick)="confirmarExclusao(movimentacao)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Modal de Movimentação -->
  <p-dialog 
    [(visible)]="displayModal" 
    [header]="modalTitle"
    [modal]="true" 
    [style]="{width: '60rem'}"
    [draggable]="false" 
    [resizable]="false"
    (onHide)="fecharModal()">

    <div class="modal-content">
      <form class="movimentacao-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="modal-produto">Produto *</label>
            <p-dropdown 
              id="modal-produto"
              [options]="produtos" 
              [(ngModel)]="movimentacaoEditando.produtoId"
              name="produtoId"
              placeholder="Selecione um produto"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>

          <div class="form-group">
            <label for="modal-tipo">Tipo de Movimentação *</label>
            <p-dropdown 
              id="modal-tipo"
              [options]="tipoMovimentacaoOptions" 
              [(ngModel)]="movimentacaoEditando.tipoMovimentacao"
              name="tipoMovimentacao"
              placeholder="Selecione o tipo"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>

          <div class="form-group">
            <label for="modal-quantidade">Quantidade *</label>
            <p-inputNumber 
              id="modal-quantidade"
              [(ngModel)]="movimentacaoEditando.quantidade"
              name="quantidade"
              placeholder="0"
              [min]="0">
            </p-inputNumber>
          </div>

          <div class="form-group">
            <label for="modal-motivo">Motivo *</label>
            <p-dropdown 
              id="modal-motivo"
              [options]="motivoMovimentacaoOptions" 
              [(ngModel)]="movimentacaoEditando.motivo"
              name="motivo"
              placeholder="Selecione o motivo"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>

          <div class="form-group">
            <label for="modal-documento">Documento</label>
            <input 
              id="modal-documento"
              type="text" 
              pInputText 
              [(ngModel)]="movimentacaoEditando.documento"
              name="documento"
              placeholder="Digite o documento">
          </div>

          <div class="form-group">
            <label for="modal-fornecedor">Fornecedor</label>
            <input 
              id="modal-fornecedor"
              type="text" 
              pInputText 
              [(ngModel)]="movimentacaoEditando.fornecedor"
              name="fornecedor"
              placeholder="Digite o fornecedor">
          </div>

          <div class="form-group">
            <label for="modal-cliente">Cliente</label>
            <input 
              id="modal-cliente"
              type="text" 
              pInputText 
              [(ngModel)]="movimentacaoEditando.cliente"
              name="cliente"
              placeholder="Digite o cliente">
          </div>
        </div>

        <div class="form-group full-width">
          <label for="modal-observacoes">Observações</label>
          <textarea 
            id="modal-observacoes"
            pInputTextarea 
            [(ngModel)]="movimentacaoEditando.observacoes"
            name="observacoes"
            [rows]="3"
            placeholder="Digite as observações">
          </textarea>
        </div>
      </form>
    </div>

    <ng-template pTemplate="footer">
      <div class="modal-footer">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          severity="secondary"
          (onClick)="fecharModal()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="primary"
          (onClick)="salvarMovimentacao()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de Confirmação de Exclusão -->
  <p-dialog 
    [(visible)]="displayConfirmation" 
    [header]="modalTitleDelete"
    [modal]="true" 
    [style]="{width: '30rem'}"
    [draggable]="false" 
    [resizable]="false">

    <div class="confirmation-content">
      <i class="pi pi-exclamation-triangle" style="font-size: 3rem; color: #f44336;"></i>
      <p>Tem certeza que deseja excluir esta movimentação?</p>
      <p class="warning-text">Esta ação não pode ser desfeita.</p>
    </div>

    <ng-template pTemplate="footer">
      <div class="confirmation-footer">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          severity="secondary"
          (onClick)="cancelarExclusao()">
        </p-button>
        <p-button 
          label="Confirmar" 
          icon="pi pi-check" 
          severity="danger"
          (onClick)="confirmarExclusaoDialog()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div> 