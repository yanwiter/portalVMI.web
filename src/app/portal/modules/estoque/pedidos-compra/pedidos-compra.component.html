<div class="pedidos-compra">
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-shopping-cart"></i>
        Gestão de Pedidos de Compra
      </h1>
      <div class="header-actions">
        <p-button 
          icon="pi pi-plus" 
          label="Novo Pedido" 
          severity="primary"
          (onClick)="showDialog()">
        </p-button>
        <p-button 
          icon="pi pi-download" 
          label="Exportar" 
          severity="secondary"
          (onClick)="exportarParaExcel()">
        </p-button>
      </div>
    </div>
  </div>

  <div class="filtros-section">
    <div class="filtros-header">
      <h3>{{ getFiltrosHeader() }}</h3>
      <div class="filtros-actions">
        <p-button 
          icon="pi pi-search" 
          label="Filtrar" 
          severity="primary"
          size="small"
          (onClick)="filtrar()">
        </p-button>
        <p-button 
          icon="pi pi-times" 
          label="Limpar" 
          severity="secondary"
          size="small"
          (onClick)="limparFiltros()">
        </p-button>
      </div>
    </div>

    <div class="filtros-content">
      <div class="filtros-grid">
        <div class="filtro-item">
          <label for="numero">Número</label>
          <input 
            id="numero"
            type="text" 
            pInputText 
            [(ngModel)]="filtros.numero"
            placeholder="Digite o número">
        </div>

        <div class="filtro-item">
          <label for="fornecedor">Fornecedor</label>
          <p-dropdown 
            id="fornecedor"
            [options]="fornecedores" 
            [(ngModel)]="filtros.fornecedorId"
            placeholder="Selecione o fornecedor"
            optionLabel="label"
            optionValue="value">
          </p-dropdown>
        </div>

        <div class="filtro-item">
          <label for="status">Status</label>
          <p-dropdown 
            id="status"
            [options]="statusPedidoOptions" 
            [(ngModel)]="filtros.status"
            placeholder="Selecione o status"
            optionLabel="label"
            optionValue="value">
          </p-dropdown>
        </div>

        <div class="filtro-item">
          <label for="data-inicio">Data Início</label>
          <p-calendar 
            id="data-inicio"
            [(ngModel)]="filtros.dataInicio"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data">
          </p-calendar>
        </div>

        <div class="filtro-item">
          <label for="data-fim">Data Fim</label>
          <p-calendar 
            id="data-fim"
            [(ngModel)]="filtros.dataFim"
            dateFormat="dd/mm/yy"
            placeholder="Selecione a data">
          </p-calendar>
        </div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <p-table 
      [value]="pedidosCompra" 
      [lazy]="true"
      [lazyLoadOnInit]="false"
      [paginator]="true"
      [rows]="currentRowsPerPage"
      [rowsPerPageOptions]="rowsPerPage"
      [totalRecords]="totalRecords"
      [loading]="tblLazyLoading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} pedidos"
      [tableStyle]="{'min-width': '50rem'}"
      (onLazyLoad)="loadTableData($event)"
      (onPage)="handlePageChange($event)"
      styleClass="p-datatable-gridlines">

      <ng-template pTemplate="header">
        <tr>
          <th>Número</th>
          <th>Fornecedor</th>
          <th>Data Pedido</th>
          <th>Data Entrega</th>
          <th>Valor Total</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-pedido>
        <tr>
          <td>{{ pedido.numero }}</td>
          <td>{{ pedido.fornecedor?.nome }}</td>
          <td>{{ pedido.dataPedido }}</td>
          <td>{{ pedido.dataEntrega }}</td>
          <td>{{ formatarValor(pedido.valorTotal) }}</td>
          <td>
            <p-tag 
              [value]="pedido.status" 
              [severity]="getSeverity(pedido.status)">
            </p-tag>
          </td>
          <td>
            <div class="acoes-buttons">
              <p-button 
                icon="pi pi-pencil" 
                severity="info"
                size="small"
                pTooltip="Editar"
                (onClick)="iniciarEdicao(pedido)">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                size="small"
                pTooltip="Excluir"
                (onClick)="confirmarExclusao(pedido)">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Modal de Pedido de Compra -->
  <p-dialog 
    [(visible)]="displayModal" 
    [header]="modalTitle"
    [modal]="true" 
    [style]="{width: '80rem'}"
    [draggable]="false" 
    [resizable]="false"
    (onHide)="fecharModal()">

    <div class="modal-content">
      <form class="pedido-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="modal-fornecedor">Fornecedor *</label>
            <p-dropdown 
              id="modal-fornecedor"
              [options]="fornecedores" 
              [(ngModel)]="pedidoEditando.fornecedorId"
              name="fornecedorId"
              placeholder="Selecione o fornecedor"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>

          <div class="form-group">
            <label for="modal-data-pedido">Data do Pedido *</label>
            <p-calendar 
              id="modal-data-pedido"
              [(ngModel)]="pedidoEditando.dataPedido"
              name="dataPedido"
              dateFormat="dd/mm/yy"
              placeholder="Selecione a data">
            </p-calendar>
          </div>

          <div class="form-group">
            <label for="modal-data-entrega">Data de Entrega</label>
            <p-calendar 
              id="modal-data-entrega"
              [(ngModel)]="pedidoEditando.dataEntrega"
              name="dataEntrega"
              dateFormat="dd/mm/yy"
              placeholder="Selecione a data">
            </p-calendar>
          </div>

          <div class="form-group">
            <label for="modal-status">Status</label>
            <p-dropdown 
              id="modal-status"
              [options]="statusPedidoOptions" 
              [(ngModel)]="pedidoEditando.status"
              name="status"
              placeholder="Selecione o status"
              optionLabel="label"
              optionValue="value">
            </p-dropdown>
          </div>
        </div>

        <div class="form-group full-width">
          <label for="modal-observacoes">Observações</label>
          <textarea 
            id="modal-observacoes"
            pInputTextarea 
            [(ngModel)]="pedidoEditando.observacoes"
            name="observacoes"
            [rows]="3"
            placeholder="Digite as observações">
          </textarea>
        </div>

        <!-- Seção de Itens -->
        <div class="itens-section">
          <div class="itens-header">
            <h4>Itens do Pedido</h4>
            <p-button 
              icon="pi pi-plus" 
              label="Adicionar Item" 
              severity="success"
              size="small"
              (onClick)="adicionarItem()">
            </p-button>
          </div>

          <div class="itens-content">
            <div class="item-row" *ngFor="let item of pedidoEditando.itens; let i = index">
              <div class="item-grid">
                <div class="form-group">
                  <label>Produto *</label>
                  <p-dropdown 
                    [options]="produtos" 
                    [(ngModel)]="item.produtoId"
                    placeholder="Selecione o produto"
                    optionLabel="label"
                    optionValue="value">
                  </p-dropdown>
                </div>

                <div class="form-group">
                  <label>Quantidade *</label>
                  <p-inputNumber 
                    [(ngModel)]="item.quantidade"
                    placeholder="0"
                    [min]="1"
                    (onInput)="calcularValorItem(item)">
                  </p-inputNumber>
                </div>

                <div class="form-group">
                  <label>Preço Unitário *</label>
                  <p-inputNumber 
                    [(ngModel)]="item.precoUnitario"
                    mode="currency" 
                    currency="BRL"
                    locale="pt-BR"
                    placeholder="0,00"
                    (onInput)="calcularValorItem(item)">
                  </p-inputNumber>
                </div>

                <div class="form-group">
                  <label>Valor Total</label>
                  <p-inputNumber 
                    [(ngModel)]="item.valorTotal"
                    mode="currency" 
                    currency="BRL"
                    locale="pt-BR"
                    [readonly]="true"
                    placeholder="0,00">
                  </p-inputNumber>
                </div>

                <div class="form-group">
                  <label>&nbsp;</label>
                  <p-button 
                    icon="pi pi-trash" 
                    severity="danger"
                    size="small"
                    (onClick)="removerItem(i)">
                  </p-button>
                </div>
              </div>
            </div>
          </div>

          <div class="valor-total">
            <h4>Valor Total do Pedido: {{ formatarValor(calcularValorTotal()) }}</h4>
          </div>
        </div>
      </form>
    </div>

    <ng-template pTemplate="footer">
      <div class="modal-footer">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          severity="secondary"
          (onClick)="fecharModal()">
        </p-button>
        <p-button 
          label="Salvar" 
          icon="pi pi-check" 
          severity="primary"
          (onClick)="salvarPedido()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Modal de Confirmação de Exclusão -->
  <p-dialog 
    [(visible)]="displayConfirmation" 
    [header]="modalTitleDelete"
    [modal]="true" 
    [style]="{width: '30rem'}"
    [draggable]="false" 
    [resizable]="false">

    <div class="confirmation-content">
      <i class="pi pi-exclamation-triangle" style="font-size: 3rem; color: #f44336;"></i>
      <p>Tem certeza que deseja excluir o pedido <strong>{{ pedidoParaExcluir?.numero }}</strong>?</p>
      <p class="warning-text">Esta ação não pode ser desfeita.</p>
    </div>

    <ng-template pTemplate="footer">
      <div class="confirmation-footer">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          severity="secondary"
          (onClick)="cancelarExclusao()">
        </p-button>
        <p-button 
          label="Confirmar" 
          icon="pi pi-check" 
          severity="danger"
          (onClick)="confirmarExclusaoDialog()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div> 